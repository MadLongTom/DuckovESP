# ESP 系统测试清单

## 📋 测试前准备

### 1. 编译检查
- [x] Release 编译成功
- [x] DLL 文件生成: `DuckovESPv3\bin\Release\netstandard2.1\DuckovESPv3.dll`
- [ ] DLL 文件大小合理（预期 ~100-200 KB）

### 2. 文件部署
```
复制文件:
FROM: D:\VSProjects\DuckovESPv3\DuckovESPv3\DuckovESPv3\bin\Release\netstandard2.1\DuckovESPv3.dll
TO:   [游戏根目录]\Mods\DuckovESPv3.dll
```

---

## 🧪 基础功能测试

### Test 1: Mod 加载
- [ ] 启动游戏
- [ ] 检查日志中是否有: `[ModBehaviour] DuckovESPv3 Mod 正在初始化...`
- [ ] 检查是否有: `[ESPMarkerPool] 程序化创建 Marker Prefab 完成`
- [ ] 检查是否有: `[ESPSystemManager] ESP 系统已初始化`

**预期结果**: 无错误，3 条初始化日志

---

### Test 2: 关卡加载
- [ ] 进入任意关卡
- [ ] 等待关卡完全加载
- [ ] 检查日志: `[ModBehaviour] 主关卡加载完成，清理旧数据并重新初始化采集器`
- [ ] 检查日志: `[LootboxDataCollector] 开始扫描箱子...`
- [ ] 检查日志: `[LootboxDataCollector] 发现箱子: Lootbox_XXX`

**预期结果**: 发现至少 1 个箱子

---

### Test 3: ESP 标记显示
- [ ] 在关卡中寻找箱子
- [ ] 观察是否有**圆形图标**悬浮在箱子上方
- [ ] 观察是否有**连接线**从玩家指向箱子
- [ ] 观察是否有**距离文本**显示（如 "25m"）

**预期结果**: 
- ✅ 圆形图标：白色/绿色/蓝色等
- ✅ 连接线：从玩家脚下到箱子
- ✅ 距离文本：实时更新

**如果看不到标记**:
1. 检查日志是否有: `[ESPSystemManager] 创建箱子标记: XXX`
2. 检查配置: `Enable3DESP = true`
3. 检查距离: 箱子是否在 100m 内
4. 检查过滤器: 品质是否被过滤

---

### Test 4: 颜色分级
寻找不同品质的物品，验证颜色：

| 品质 | 颜色 | 验证方法 |
|------|------|---------|
| White | 灰白色 | 普通物品 |
| Green | 绿色 | 低级装备 |
| Blue | 蓝色 | 中级装备 |
| Purple | 紫色 | 高级装备 |
| Orange | 橙色 | 稀有物品 |

- [ ] 找到至少 2 种不同颜色的标记
- [ ] 验证颜色与品质对应

**预期结果**: 不同品质物品显示不同颜色

---

### Test 5: 距离淡出
- [ ] 靠近一个箱子（<10m）
- [ ] 观察标记：应该是**不透明**的
- [ ] 远离箱子（50-100m）
- [ ] 观察标记：应该变得**半透明**
- [ ] 超过 100m
- [ ] 标记应该**完全消失**

**预期结果**: 距离越远，透明度越高

---

### Test 6: 过滤器测试

#### 6.1 品质过滤
- [ ] 按 `F8` 打开配置菜单（如果已实现）
- [ ] 或手动编辑 `config.json`: `"MinQualityFilter3D": 2`
- [ ] 重启游戏或重新进入关卡
- [ ] 验证只显示蓝色及以上品质的标记

#### 6.2 空箱子过滤
- [ ] 编辑配置: `"ShowEmptyBoxes": false`
- [ ] 重新加载
- [ ] 验证已开过的空箱子不显示标记

#### 6.3 心愿单过滤
- [ ] 在游戏中标记一些物品到心愿单
- [ ] 编辑配置: `"ShowOnlyWishlistedItems": true`
- [ ] 重新加载
- [ ] 验证只显示心愿单物品

**预期结果**: 过滤器生效，符合条件的物品才显示

---

## 🔄 动态测试

### Test 7: 物品拾取
- [ ] 靠近一个地面物品
- [ ] 观察 ESP 标记
- [ ] 拾取物品
- [ ] 验证标记**立即消失**
- [ ] 检查日志: `[ESPSystemManager] 移除物品标记: XXX`

**预期结果**: 拾取后标记立即消失

---

### Test 8: 箱子开启
- [ ] 找到一个未开启的箱子
- [ ] 观察标记颜色（根据内容物品质）
- [ ] 打开箱子，拿走所有物品
- [ ] 验证标记变化：
  - 如果 `ShowEmptyBoxes = true`: 标记变为灰色或保持
  - 如果 `ShowEmptyBoxes = false`: 标记消失

**预期结果**: 箱子状态改变时，标记正确更新

---

### Test 9: 场景切换
- [ ] 在关卡 A 中记录标记数量
- [ ] 切换到关卡 B
- [ ] 检查日志: `[ESPSystemManager] 已清理所有标记`
- [ ] 检查日志: `[ModBehaviour] 主关卡加载完成...`
- [ ] 验证关卡 B 中显示新的标记
- [ ] 切换回关卡 A
- [ ] 验证关卡 A 的标记重新生成

**预期结果**: 场景切换时正确清理和重建

---

### Test 10: 子场景加载
如果游戏支持动态加载子场景：
- [ ] 进入主场景，记录标记数量
- [ ] 触发子场景加载（如进入某个区域）
- [ ] 检查日志: `[ModBehaviour] 子场景加载完成: XXX`
- [ ] 验证**新增**标记（主场景标记仍存在）
- [ ] 标记总数 = 主场景 + 子场景

**预期结果**: 子场景物品追加显示，不覆盖主场景

---

## ⚡ 性能测试

### Test 11: 标记数量压力测试
- [ ] 进入物品密集的关卡
- [ ] 记录当前 FPS
- [ ] 启用 ESP
- [ ] 记录 ESP 启用后 FPS
- [ ] 计算 FPS 下降百分比

**性能目标**:
- <100 标记: FPS 下降 <5%
- 100-300 标记: FPS 下降 <10%
- 300-500 标记: FPS 下降 <15%

**测试方法**:
1. 使用游戏内 FPS 显示
2. 或使用 Unity Profiler（如果可以附加）
3. 观察 3-5 分钟的平均 FPS

---

### Test 12: 内存泄漏测试
- [ ] 启动游戏，记录内存占用
- [ ] 进入关卡，等待 5 分钟
- [ ] 记录内存占用
- [ ] 切换 5-10 次关卡
- [ ] 记录内存占用
- [ ] 计算内存增长

**预期结果**: 
- 内存增长 <50MB（5 分钟）
- 内存增长 <100MB（切换 10 次关卡）

**工具**: Windows 任务管理器

---

### Test 13: 对象池验证
- [ ] 启用详细日志（`UnityLogger` 第二个参数改为 `true`）
- [ ] 进入关卡
- [ ] 搜索日志: `[ESPMarkerPool]`
- [ ] 验证统计信息:
  ```
  活动=X (正在显示的标记)
  可用=Y (池中可复用的标记)
  总计=X+Y (应该 ≤500)
  ```
- [ ] 反复进出关卡
- [ ] 验证 `总计` 数量不会无限增长

**预期结果**: 总计标记数量稳定在 50-500 之间

---

## 🐛 错误处理测试

### Test 14: 极端情况
- [ ] 测试 1: 关卡中没有任何箱子/物品
  - 预期: 无错误，日志显示 "发现 0 个箱子"
  
- [ ] 测试 2: 超过 500 个标记
  - 预期: 日志警告 "已达到最大容量"，不会崩溃
  
- [ ] 测试 3: 禁用 ESP 后重新启用
  - 修改配置: `Enable3DESP = false`
  - 进入关卡：无标记
  - 修改配置: `Enable3DESP = true`
  - 重新进入关卡：标记正常显示

---

## 📊 测试结果模板

```
测试日期: 2025-10-25
测试人员: [你的名字]
游戏版本: [游戏版本号]
Mod 版本: v3.0 Phase 2

=== 基础功能 ===
[ ] Test 1: Mod 加载 - PASS/FAIL
[ ] Test 2: 关卡加载 - PASS/FAIL
[ ] Test 3: ESP 标记显示 - PASS/FAIL
[ ] Test 4: 颜色分级 - PASS/FAIL
[ ] Test 5: 距离淡出 - PASS/FAIL
[ ] Test 6: 过滤器测试 - PASS/FAIL

=== 动态测试 ===
[ ] Test 7: 物品拾取 - PASS/FAIL
[ ] Test 8: 箱子开启 - PASS/FAIL
[ ] Test 9: 场景切换 - PASS/FAIL
[ ] Test 10: 子场景加载 - PASS/FAIL

=== 性能测试 ===
[ ] Test 11: 压力测试
    - 标记数量: ___
    - FPS 前: ___
    - FPS 后: ___
    - 下降: ___%
    
[ ] Test 12: 内存测试
    - 初始: ___ MB
    - 5分钟后: ___ MB
    - 10次切换后: ___ MB
    
[ ] Test 13: 对象池
    - 活动: ___
    - 可用: ___
    - 总计: ___

=== 错误处理 ===
[ ] Test 14: 极端情况 - PASS/FAIL

总体评价: _______________
发现的问题: _______________
```

---

## 🚨 已知问题检查

### 问题 1: 标记不显示
**症状**: 进入关卡后看不到任何标记

**检查步骤**:
1. [ ] 日志中有 "ESP 系统已初始化"
2. [ ] 日志中有 "发现箱子: XXX"
3. [ ] 日志中有 "创建箱子标记: XXX"
4. [ ] 配置 `Enable3DESP = true`
5. [ ] 距离 <100m
6. [ ] 品质过滤器合理

**解决方法**: [待填写]

---

### 问题 2: 性能下降严重
**症状**: FPS 下降 >20%

**检查步骤**:
1. [ ] 标记数量 <500
2. [ ] MaxESPDistance ≤100
3. [ ] 日志中无频繁警告

**解决方法**: [待填写]

---

## ✅ 测试完成确认

所有测试完成后，确认：
- [ ] 所有基础功能测试通过
- [ ] 至少 80% 动态测试通过
- [ ] 性能达到目标
- [ ] 无严重错误

**签名**: _______________
**日期**: _______________
