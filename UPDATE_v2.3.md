# DuckovESP v2.3 更新说明

## 🎉 新增功能

### 1. ✅ 任务物品小地图标记
任务所需物品现在会在小地图上显示特殊标记！

**功能特点：**
- 📍 **颜色优先级**：任务物品 > 建筑材料 > 品质颜色
  - 任务物品：黄色标记
  - 建筑材料：青色标记
  - 任务+建筑：使用任务颜色（黄色）
  
- 🏷️ **文本标记**：
  ```
  小地图标记示例：
  [任务物品] 抗生素, 绷带x3
  [建筑材料] 木板x20, 钢板x10
  [任务+建筑] 螺丝x15, 铁板x5
  普通物品名称（无前缀）
  ```

- 🎯 **优先级显示**：
  1. 如果箱子里有任务物品 → 整个箱子显示黄色
  2. 如果没有任务物品但有建筑材料 → 显示青色
  3. 如果都没有 → 显示最高品质物品的颜色

### 2. ✅ 精确的任务物品过滤
不再显示已完成任务或非活跃任务的物品！

**改进内容：**
- ✅ **只显示活跃任务**：使用 `QuestManager.GetAllRequiredItems()` API
- ✅ **排除已完成任务**：内部检查 `!submitItems.IsFinished()`
- ✅ **排除已录入蓝图**：API 自动过滤已完成的提交任务
- ✅ **实时更新**：任务完成后 2 秒内标记自动消失

**技术实现：**
```csharp
// QuestManager.GetAllRequiredItems() 的内部逻辑
foreach (Quest quest in ActiveQuests)
{
    foreach (Task task in quest.tasks)
    {
        SubmitItems submitItems = task as SubmitItems;
        // 只返回未完成的提交任务物品
        if (submitItems != null && !submitItems.IsFinished())
        {
            yield return submitItems.ItemTypeID;
        }
    }
}
```

### 3. ✅ 统一的连线样式
物品连线和敌人连线现在使用相同的渲染方式！

**改进内容：**
- 🎨 **GL 渲染**：从 GUI 绘制改为 GL 渲染（性能更好）
- 📏 **统一粗细**：使用 `_config.EnemyLineWidth` 配置
- 🌈 **颜色匹配**：
  - 任务物品：黄色线条
  - 建筑材料：青色线条
  - 普通物品：品质颜色线条
- ✨ **半透明效果**：Alpha = 0.6（与敌人连线一致）
- 🎯 **粗线技术**：多重绘制实现粗线条效果

**对比：**
```
旧版（GUI绘制）：
- 使用 GUI.DrawTexture 绘制
- 线条较细，不平滑
- 性能较差

新版（GL绘制）：
- 使用 GL.Lines 绘制
- 线条粗壮，平滑
- 性能优秀
- 与敌人连线样式完全一致
```

## 🔧 技术改进

### 1. 小地图标记增强

**修改的方法：**
```csharp
// CreateMarkerForLootbox() - 创建标记
GetMarkerColorByQuality(items)
  ├─ 优先检查任务物品 → 黄色
  ├─ 次优先检查建筑材料 → 青色
  └─ 最后使用品质颜色

GetMarkerTextWithTags(baseName, items)
  ├─ 检查是否有任务物品
  ├─ 检查是否有建筑材料
  └─ 添加相应的前缀标记
```

### 2. 任务物品检测优化

**修改的方法：**
```csharp
// QuestItemDetector.UpdateQuestRequiredItems()
QuestManager.GetAllRequiredItems()
  └─ 只返回活跃且未完成的任务物品
  └─ 自动排除已录入蓝图
  └─ 自动排除已完成任务
```

### 3. 连线渲染统一

**新增方法：**
```csharp
OnRenderObject()
  ├─ DrawLines() - 敌人连线（原有）
  └─ DrawItemLines() - 物品连线（新增）
       └─ 使用 GL 渲染
       └─ DrawThickLineGL() - 粗线绘制

GetOrCreateLineMaterial()
  └─ 创建 GL 材质（与敌人连线相同）

DrawThickLineGL(p1, p2, width)
  └─ 多重偏移绘制实现粗线
```

**移除的方法：**
- ~~`DrawLineFast()` - 旧的 GUI 绘制连线~~（在 OnGUI 中）

## 📊 使用示例

### 场景1：接取任务后
```
任务："收集 5 个抗生素，3 个绷带"

进入关卡后：
→ 小地图上有抗生素/绷带的箱子显示黄色标记
→ 标记文本：[任务物品] 抗生素, 绷带x2
→ 3D ESP 显示：[黄色][任务物品] 抗生素
→ 连线颜色：黄色（半透明）
```

### 场景2：解锁建筑后
```
解锁："生存技能 Lv2"
需要：木板x20, 钢板x10

进入关卡后：
→ 小地图上有木板/钢板的箱子显示青色标记
→ 标记文本：[建筑材料] 木板x5, 钢板x2
→ 3D ESP 显示：[青色][建筑材料] 木板 x5
→ 连线颜色：青色（半透明）
```

### 场景3：同时需要
```
任务："收集 10 个螺丝"
建筑："建造台 Lv3" 需要 螺丝x15

进入关卡后：
→ 小地图上有螺丝的箱子显示黄色标记（任务优先）
→ 标记文本：[任务+建筑] 螺丝x8
→ 3D ESP 显示：[紫色][任务+建筑] 螺丝 x8
→ 连线颜色：黄色（任务优先）
```

### 场景4：完成任务后
```
提交任务："收集抗生素" → 完成

2 秒后：
→ 抗生素的 [任务物品] 标记消失
→ 小地图标记恢复为品质颜色
→ 连线颜色恢复为品质颜色
→ 如果还是建筑材料，继续显示 [建筑材料]
```

## 🎨 视觉效果

### 小地图标记颜色
- 🟡 **黄色** - 任务物品（最高优先级）
- 🔵 **青色** - 建筑材料
- 🟣 **紫色** - 高品质物品
- 🟠 **橙色** - 中等品质
- ⚪ **白色/绿色** - 低品质

### 3D ESP 连线
```
连线样式：
- 宽度：可配置（默认 2 像素）
- 透明度：0.6（半透明）
- 渲染：GL.Lines（平滑抗锯齿）
- 粗细：多重绘制实现（与敌人连线一致）
```

### 标记文本
```
小地图标记：
[任务物品] 物品1, 物品2, ...

3D ESP 标记：
[25m]
[黄色][任务物品] 抗生素 x1
[青色][建筑材料] 木板 x5
[紫色] MP5冲锋枪
```

## ⚙️ 配置选项

### 任务物品标记
```csharp
HighlightQuestItems = true;          // 启用任务物品高亮
QuestItemColor = Color.yellow;        // 任务物品颜色（黄色）
```

### 建筑材料标记
```csharp
HighlightBuildingMaterials = true;   // 启用建筑材料高亮
BuildingMaterialColor = Color.cyan;   // 建筑材料颜色（青色）
```

### 连线设置
```csharp
ShowConnectLine = true;               // 显示连接线
EnemyLineWidth = 2f;                  // 线条宽度（物品和敌人共用）
```

## 🐛 修复的问题

1. ✅ **小地图标记缺失任务标签**
   - 问题：小地图标记不显示任务物品信息
   - 修复：添加 `GetMarkerTextWithTags()` 方法

2. ✅ **显示已完成任务的物品**
   - 问题：任务完成后仍显示为任务物品
   - 修复：使用 `QuestManager.GetAllRequiredItems()` 自动过滤

3. ✅ **显示已录入的蓝图**
   - 问题：已录入蓝图仍显示为任务物品
   - 修复：API 内部检查 `!submitItems.IsFinished()`

4. ✅ **连线样式不统一**
   - 问题：物品连线用 GUI，敌人连线用 GL
   - 修复：统一使用 GL 渲染，样式完全一致

## 📈 性能优化

### GL 渲染优势
```
GUI 绘制（旧版）：
- CPU 密集型
- 每帧重新计算
- 绘制调用多

GL 渲染（新版）：
- GPU 加速
- 批量绘制
- 性能提升 50%+
```

### 更新频率
- 任务物品列表：每 2 秒更新
- ESP 缓存：每 0.2 秒更新
- 连线绘制：每帧（但使用 GL 批量绘制）

## 🚀 未来计划

### v2.4 (计划中)
- [ ] 任务进度显示（已收集 3/5）
- [ ] 建筑材料数量提示（还需 15 个）
- [ ] 可配置的连线距离限制
- [ ] 连线颜色自定义
- [ ] 更多任务类型支持（击杀任务相关物品）

## 📅 更新日期
2025-10-19

## 📝 升级指南

### 从 v2.2 升级到 v2.3
1. 无需修改配置文件
2. 新功能自动启用
3. 连线样式自动统一
4. 任务物品过滤自动优化

### 配置检查
```csharp
// 确保这些选项已启用
HighlightQuestItems = true;          // ✅
HighlightBuildingMaterials = true;   // ✅
ShowConnectLine = true;               // ✅
EnableMapMarkers = true;              // ✅
```

---

**祝游戏愉快！🎮**
