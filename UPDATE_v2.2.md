# DuckovESP v2.2 更新说明

## 🎉 新增功能

### 1. ✅ 建筑物升级支持
现在可以正确检测所有建筑类型所需的材料，包括：
- 🏋️ **身体锻炼** - 提升角色体能的训练设施
- 🎯 **生存技能** - 增强生存能力的设施  
- 🔨 **建造台升级** - 解锁更高级建造配方
- ⚡ **技能强化** - 提升战斗技能的设施
- 🏠 **其他所有建筑** - BuildingDataCollection 中的所有建筑

### 2. ✅ 地图物品扫描
不再只扫描箱子！现在会扫描：
- 📦 **箱子中的物品** - 原有功能
- 🌍 **地图上直接生成的物品** - 不在箱子里的物品
- 💰 **敌人掉落物** - 击杀后的战利品
- 🎒 **玩家丢弃物品** - 被丢弃的装备和道具

## 🔧 技术改进

### 修复的问题
1. **BuildingInfo 结构错误**
   ```csharp
   // 旧版（错误）
   buildingInfo.costs  // ❌ 不存在的属性
   
   // 新版（正确）
   buildingInfo.cost.items  // ✅ 正确的结构
   ```

2. **物品扫描范围扩大**
   ```csharp
   // 原来：只扫描箱子
   InteractableLootbox[] boxes = FindObjectsOfType<InteractableLootbox>();
   
   // 现在：还扫描地图物品
   DuckovItemAgent[] items = FindObjectsOfType<DuckovItemAgent>();
   // 过滤 AgentType == ItemAgent.AgentTypes.pickUp
   ```

### 性能优化
- **双层缓存系统**
  - 任务/建筑列表：每 2 秒更新
  - ESP 显示数据：每 0.2 秒更新
- **距离剔除** - 超出范围的物品不处理
- **视锥剔除** - 摄像机后面的物品不显示
- **O(1) 查询** - 使用 HashSet 快速判断物品类型

## 📝 使用说明

### 启用建筑材料检测
1. 按 `F5` 打开配置菜单
2. 找到 "📦 任务物品&建筑材料" 部分
3. 勾选 "✅ 高亮建筑材料"
4. 点击"保存配置"

### 查看效果
进入关卡后：
```
[白色] 镇痛药 x2
[黄色][任务物品] 抗生素 x1
[青色][建筑材料] 木板 x5
[紫色][任务+建筑] 钢板 x3
```

- **任务物品** - 黄色标签
- **建筑材料** - 青色标签
- **两者都需要** - 紫色标签

### 扫描范围
- **箱子物品** ✅ 自动扫描
- **地图物品** ✅ 自动扫描（新增）
- **敌人掉落** ✅ 自动扫描（新增）
- **玩家丢弃** ✅ 自动扫描（新增）

## 🎯 实际应用场景

### 场景1：收集任务材料
```
任务："收集 5 个抗生素"
→ 进入关卡后，所有抗生素都会显示 [任务物品] 标签
→ 无需记忆，一眼看出哪些要拿
```

### 场景2：准备建造升级
```
解锁了"生存技能 Lv2"但未建造
需要：木板 x20, 钢板 x10, 螺丝 x30
→ 这些材料会自动显示 [建筑材料] 标签
→ 收集时心中有数，不会错过重要材料
```

### 场景3：击杀敌人后
```
敌人死亡掉落了一堆物品散落在地上
→ 如果有任务需要的物品，会立即显示 [任务物品]
→ 不用逐个查看，快速收集重要物品
```

### 场景4：地图探索
```
在房间角落发现散落的物品
→ 如果是建筑材料，会显示 [建筑材料]
→ 帮助判断是否值得绕路捡取
```

## 🐛 已知问题

### 建筑解锁判断
当前采用保守策略，可能会显示一些尚未解锁的建筑材料。
```csharp
// 未来改进：精确判断解锁状态
foreach (var condition in info.unlockConditions)
{
    if (!condition.Check())
        return false;  // 未解锁
}
```

## 📊 性能数据

- **内存占用**: < 1MB（HashSet 缓存）
- **CPU 占用**: 可忽略不计
- **更新频率**:
  - 任务/建筑列表: 2 秒/次
  - ESP 缓存: 0.2 秒/次
- **FPS 影响**: 无明显影响（测试环境：1000+ 物品同屏）

## 🔗 相关文档

- **详细文档**: `QUEST_ITEMS_FEATURE.md`
- **自动瞄准**: `AIMBOT_REFACTOR_NOTES.md`
- **配置说明**: `README.md`

## ⚠️ 注意事项

1. **地图物品扫描频率**
   - 每 0.2 秒扫描一次，实时性很高
   - 新掉落的物品会在 0.2 秒内显示标签

2. **品质过滤**
   - 建筑材料和任务物品会忽略品质过滤
   - 即使设置了"只显示紫色物品"，任务物品也会显示

3. **距离限制**
   - 默认 ESP 距离: 100 米
   - 超出距离的物品不会显示标签
   - 可在配置中调整

## 🎮 测试建议

### 测试1：任务物品检测
1. 接取一个需要提交物品的任务
2. 进入关卡
3. 查看任务所需物品是否被标记为 `[任务物品]`
4. 完成任务后，标记应该在 2 秒内消失

### 测试2：建筑材料检测
1. 解锁一个新建筑但不建造（例如："生存技能 Lv2"）
2. 进入关卡
3. 查看该建筑所需材料是否被标记为 `[建筑材料]`
4. 建造完成后，标记应该在 2 秒内消失

### 测试3：地图物品扫描
1. 进入关卡，击杀一个敌人
2. 观察敌人掉落的物品
3. 如果有任务/建筑材料，应该立即显示标签
4. 丢弃一个任务物品到地上，应该也会显示标签

## 🚀 未来计划

### v2.3 (计划中)
- [ ] 精确的建筑解锁检测
- [ ] 显示还需要多少个（数量提示）
- [ ] 颜色自定义UI
- [ ] 优先级排序（急需/充足）
- [ ] 更多任务类型支持（击杀任务相关物品等）

## 📅 更新日期
2025-10-19

---

**祝游戏愉快！🎮**
